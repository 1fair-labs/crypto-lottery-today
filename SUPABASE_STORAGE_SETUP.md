# Настройка Supabase Storage для аватаров

## Проблема
Telegram Bot API не хранит файлы долго. URL аватаров становятся невалидными (404) после холодного старта или через некоторое время. Также публичные URL с `telegram_id` в имени файла нарушают приватность пользователей.

## Решение
Аватары скачиваются и сохраняются в Supabase Storage с хешированными именами файлов для приватности. Система отслеживает изменения аватара по `file_id` и автоматически обновляет при изменении.

## Шаг 1: Создайте bucket в Supabase Storage

1. Откройте ваш проект в [Supabase Dashboard](https://app.supabase.com)
2. Перейдите в **Storage** в левом меню
3. Нажмите **New bucket**
4. Назовите bucket: `avatars`
5. Установите **Public bucket** (чтобы аватары были доступны публично)
6. Нажмите **Create bucket**

## Шаг 2: Настройте политики безопасности (RLS)

1. В Storage перейдите в **Policies** для bucket `avatars`
2. Добавьте политику для чтения (SELECT):
   - Policy name: `Public read access`
   - Allowed operation: `SELECT`
   - Target roles: `anon`, `authenticated`
   - Policy definition: `true` (разрешить всем)

3. Добавьте политику для записи (INSERT/UPDATE):
   - Policy name: `Service role upload`
   - Allowed operation: `INSERT`, `UPDATE`
   - Target roles: `service_role` (используется серверными функциями)
   - Policy definition: `true`

**Важно:** Для записи через serverless функции Vercel используется `service_role` key, который должен быть в переменных окружения.

## Шаг 3: Выполните миграцию базы данных

Добавьте поле для отслеживания `file_id` аватара:

1. Откройте **SQL Editor** в Supabase Dashboard
2. Скопируйте содержимое файла `database_avatar_file_id_migration.sql`
3. Выполните SQL запрос

Это добавит поле `avatar_file_id` в таблицу `users` для отслеживания изменений аватара.

## Шаг 4: Проверьте переменные окружения в Vercel

Убедитесь, что в Vercel настроены переменные окружения:
- `VITE_SUPABASE_URL` - URL вашего проекта Supabase
- `VITE_SUPABASE_ANON_KEY` - Anon key из Supabase (для чтения)
- `SUPABASE_SERVICE_ROLE_KEY` - Service role key (для записи в Storage)
- `AVATAR_SALT` (опционально) - Секретный ключ для хеширования имен файлов (по умолчанию используется дефолтное значение)

**Где найти Service Role Key:**
1. В Supabase Dashboard → **Settings** → **API**
2. Найдите **service_role** key (секретный ключ)
3. Добавьте его в Vercel как `SUPABASE_SERVICE_ROLE_KEY`

**Рекомендуется:** Установите `AVATAR_SALT` в Vercel для дополнительной безопасности хеширования имен файлов.

## Как это работает

1. **При логине:**
   - Получаем `file_id` текущего аватара из Telegram API
   - Проверяем, изменился ли аватар (сравниваем `file_id` с сохраненным)
   - Если изменился или отсутствует - скачиваем файл с Telegram API
   - Генерируем хешированное имя файла: `sha256(telegram_id + AVATAR_SALT)[:32].jpg`
   - Сохраняем в Supabase Storage с хешированным именем
   - Сохраняем публичный URL и `file_id` в БД

2. **При загрузке страницы:**
   - Проверяется валидность URL аватара
   - Если URL из Supabase Storage - всегда валиден
   - Если URL невалиден - автоматически обновляется через API `/api/auth/refresh-avatar`

3. **При изменении аватара в Telegram:**
   - При следующем логине система обнаружит новый `file_id`
   - Автоматически скачает и обновит аватар в Storage

## Преимущества

- ✅ **Приватность:** Хешированные имена файлов - нельзя угадать `telegram_id` по имени файла
- ✅ **Надежность:** Аватары всегда доступны (не зависят от Telegram API)
- ✅ **Автоматическое обновление:** Система отслеживает изменения аватара по `file_id`
- ✅ **Быстрая загрузка:** CDN Supabase для быстрой доставки
- ✅ **Безопасность:** Нет fallback на временные URL Telegram API

## Приватность

Имена файлов хешируются с использованием `sha256(telegram_id + AVATAR_SALT)`, что означает:
- Невозможно угадать `telegram_id` по имени файла
- Невозможно перебрать все аватары пользователей
- Даже при публичном bucket приватность сохраняется

## Миграция существующих аватаров

1. Выполните SQL миграцию `database_avatar_file_id_migration.sql`
2. Существующие аватары с URL Telegram API будут автоматически обновлены при следующем логине пользователя
3. Старые файлы в Storage (если использовались имена с `telegram_id`) можно удалить вручную

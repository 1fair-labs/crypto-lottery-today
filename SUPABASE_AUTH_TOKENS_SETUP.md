# Настройка таблицы auth_tokens в Supabase

## Проблема
Токены авторизации хранились в памяти (in-memory), что приводило к их потере при холодном старте Vercel serverless функций. Теперь токены хранятся в Supabase для надежности.

## Решение

### Шаг 1: Создайте таблицу в Supabase

1. Откройте ваш проект в [Supabase Dashboard](https://app.supabase.com)
2. Перейдите в **SQL Editor**
3. Скопируйте содержимое файла `database_auth_tokens.sql`
4. Вставьте SQL в редактор и нажмите **Run**

Это создаст:
- Таблицу `auth_tokens` для хранения токенов авторизации
- Индексы для быстрого поиска
- Политики безопасности (RLS)

### Шаг 2: Проверьте переменные окружения в Vercel

Убедитесь, что в Vercel настроены переменные окружения:
- `VITE_SUPABASE_URL` - URL вашего проекта Supabase
- `VITE_SUPABASE_ANON_KEY` - Anon key из Supabase

Если их нет, добавьте их в **Settings** → **Environment Variables** в Vercel Dashboard.

### Шаг 3: Передеплойте проект

После создания таблицы:
1. Перейдите в **Deployments** в Vercel
2. Найдите последний деплой
3. Нажмите на три точки (⋮) → **Redeploy**

Или сделайте новый коммит и push в репозиторий.

## Как это работает

1. **Генерация токена**: При нажатии "Connect via Telegram" токен сохраняется в Supabase
2. **Авторизация**: Когда пользователь нажимает `/start` в боте, токен проверяется в Supabase
3. **Привязка пользователя**: После успешной проверки пользователь привязывается к токену
4. **Callback**: Пользователь переходит по ссылке, токен удаляется из Supabase (одноразовый)

## Важные замечания

- Токены автоматически истекают через 5 минут
- Истекшие токены можно очистить вручную через SQL: `SELECT cleanup_expired_tokens();`
- Таблица использует Row Level Security (RLS) для безопасности
